name: Build Windows CLAP

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build_windows_clap:
    name: Build Windows CLAP
    runs-on: windows-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Clone JUCE 7 Framework
        run: |
          git clone --depth 1 --branch 7.0.12 https://github.com/juce-framework/JUCE.git libs/JUCE_7

      - name: Setup CLAP Extensions
        run: |
          git clone --recursive https://github.com/free-audio/clap-juce-extensions.git libs/CLAP_Extensions

      - name: Configure CMake for CLAP
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DJUCE_DIR=libs/JUCE_7 `
            -DCLAP_EXTENSIONS_DIR=libs/CLAP_Extensions `
            -DVILLAIN_ENABLE_VST3=OFF `
            -DVILLAIN_ENABLE_AU=OFF `
            -DVILLAIN_ENABLE_CLAP=ON

      - name: Build CLAP
        run: cmake --build build --config Release --parallel 4

      - name: Verify CLAP Build
        shell: pwsh
        run: |
          Write-Host "Checking for CLAP output..."
          if (Test-Path "build/Villain_artefacts/Release/CLAP/Villain.clap") {
            Write-Host "✓ CLAP binary found!"
            Get-ChildItem "build/Villain_artefacts/Release/CLAP/" -Recurse
          } else {
            Write-Host "✗ CLAP binary NOT found!"
            Get-ChildItem "build/Villain_artefacts/" -Recurse
            exit 1
          }

      - name: Create CLAP Bundle Structure
        shell: pwsh
        run: |
          $clapDir = "Villain.clap"
          clapDir/Contents"
          contentsDir/x86_64-win"
          
          Write-Host "Creating CLAP bundle structure..."
          
          # Create directory structure
          New-Item -ItemType Directory -Force -Path $winDir | Out-Null
          
          # Copy DLL to correct location
          if (Test-Path "build/Villain_artefacts/Release/CLAP/Villain.clap") {
            Copy-Item "build/Villain_artefacts/Release/CLAP/Villain.clap" "$winDir/Villain.clap"
            Write-Host "✓ Copied CLAP binary to $winDir"
          } else {
            Write-Host "✗ Source CLAP file not found!"
            exit 1
          }
          
          # Create clap.json manifest
          $manifest = @{
            "clap-version" = "1.2.0"
            "type" = "plugin"
          } | ConvertTo-Json
          Set-Content -Path "manifest
          Write-Host "✓ Created clap.json manifest"
          
          # Verify structure
          Write-Host "`nFinal CLAP bundle structure:"
          Get-ChildItem $clapDir -Recurse | Select-Object FullName

      - name: Upload Windows CLAP
        uses: actions/upload-artifact@v4
        with:
          name: Villain-Windows-CLAP
          path: Villain.clap/
          if-no-files-found: error