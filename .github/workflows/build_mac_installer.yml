name: Build macOS (VST3/AU/CLAP)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PLUGIN_NAME: "Villain"
  PLUGIN_VERSION: "1.0.0"

jobs:
  build_mac:
    name: Build macOS All Formats
    runs-on: macos-14

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Dependencies
        run: |
          brew install ninja
          brew install cmake || brew upgrade cmake

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Import Signing Certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
          P12_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: "admin"
        run: |
          echo $BUILD_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productsign
          security set-key-partition-list -S apple-tool:,apple:,codesign:,productsign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain

      - name: Clone JUCE 8.0.12 Framework
        run: |
          git clone --depth 1 --branch 8.0.12 https://github.com/juce-framework/JUCE.git libs/JUCE

      - name: Setup CLAP Extensions
        run: |
          git clone --recursive https://github.com/free-audio/clap-juce-extensions.git libs/CLAP_Extensions

      # ── Build VST3 + CLAP ──
      - name: Configure CMake (VST3 + CLAP)
        run: |
          cmake -B build_vst3_clap -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
            -DJUCE_DIR=libs/JUCE \
            -DCLAP_EXTENSIONS_DIR=libs/CLAP_Extensions \
            -DVILLAIN_ENABLE_VST3=ON \
            -DVILLAIN_ENABLE_AU=OFF \
            -DVILLAIN_ENABLE_CLAP=ON

      - name: Build VST3 + CLAP
        run: cmake --build build_vst3_clap --config Release --parallel 4

      # ── Build AU separately ──
      - name: Configure CMake (AU)
        run: |
          cmake -B build_au -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
            -DJUCE_DIR=libs/JUCE \
            -DVILLAIN_ENABLE_VST3=OFF \
            -DVILLAIN_ENABLE_AU=ON \
            -DVILLAIN_ENABLE_CLAP=OFF

      - name: Build AU
        run: cmake --build build_au --config Release --parallel 4

      - name: Verify Builds
        run: |
          echo "=== Checking build artefacts ==="
          FAIL=0

          if [ -d "build_vst3_clap/Villain_artefacts/Release/VST3/Villain.vst3" ]; then
            echo "✅ VST3 found"
          else
            echo "❌ VST3 NOT found"; FAIL=1
          fi

          if [ -d "build_au/Villain_artefacts/Release/AU/Villain.component" ]; then
            echo "✅ AU found"
          else
            echo "❌ AU NOT found"; FAIL=1
          fi

          if [ -d "build_vst3_clap/Villain_artefacts/Release/CLAP/Villain.clap" ]; then
            echo "✅ CLAP found"
          else
            echo "⚠️  CLAP not found (non-critical)"
          fi

          if [ $FAIL -eq 1 ]; then exit 1; fi

      # ── Sign, notarize, staple each bundle ──
      - name: Create Notarization Script
        run: |
          cat > notarize_all.sh << 'EOF'
          #!/bin/bash
          set -e

          security unlock-keychain -p "admin" build.keychain
          security list-keychains -d user -s build.keychain
          IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID Application" | head -1 | grep -o '"[^"]*"' | sed 's/"//g')
          echo "Signing with: $IDENTITY"

          sign_and_notarize() {
            local BUNDLE="$1"
            local ZIP_NAME="$2"
            local NAME=$(basename "$BUNDLE")
            echo "=== Processing $NAME ==="

            # Sign inner binaries first
            find "$BUNDLE" -type f \( -name "*.dylib" -o -name "*.so" \) \
              -exec codesign --force --strict --options runtime --sign "$IDENTITY" --timestamp {} \;

            find "$BUNDLE" -type d -name "*.framework" \
              -exec codesign --force --strict --options runtime --sign "$IDENTITY" --timestamp {} \;

            # Sign outer bundle
            codesign --force --strict --options runtime --sign "$IDENTITY" --timestamp "$BUNDLE"
            codesign --verify --strict --verbose=2 "$BUNDLE"

            # Notarize
            /usr/bin/ditto -c -k --keepParent "$BUNDLE" "$ZIP_NAME"
            xcrun notarytool submit "$ZIP_NAME" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_PASSWORD" \
              --team-id "$TEAM_ID" \
              --wait

            # Staple
            xcrun stapler staple "$BUNDLE"
            echo "$NAME done ✅"
          }

          # VST3
          sign_and_notarize "build_vst3_clap/Villain_artefacts/Release/VST3/Villain.vst3" "Villain_VST3.zip"

          # AU
          sign_and_notarize "build_au/Villain_artefacts/Release/AU/Villain.component" "Villain_AU.zip"

          # CLAP
          if [ -d "build_vst3_clap/Villain_artefacts/Release/CLAP/Villain.clap" ]; then
            sign_and_notarize "build_vst3_clap/Villain_artefacts/Release/CLAP/Villain.clap" "Villain_CLAP.zip"
          fi
          EOF
          chmod +x notarize_all.sh

      - name: Sign & Notarize All with Retry
        uses: nick-fields/retry@v3
        env:
          APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_USERNAME }}
          APPLE_PASSWORD: ${{ secrets.MACOS_NOTARIZATION_PASSWORD }}
          TEAM_ID: ${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}
        with:
          timeout_minutes: 45
          max_attempts: 3
          retry_wait_seconds: 60
          command: ./notarize_all.sh

      # ── Create DMG with all formats ──
      - name: Create DMG
        run: |
          mkdir -p dmg_contents/VST3
          mkdir -p dmg_contents/AU
          mkdir -p dmg_contents/CLAP

          cp -R "build_vst3_clap/Villain_artefacts/Release/VST3/Villain.vst3" dmg_contents/VST3/
          cp -R "build_au/Villain_artefacts/Release/AU/Villain.component" dmg_contents/AU/

          if [ -d "build_vst3_clap/Villain_artefacts/Release/CLAP/Villain.clap" ]; then
            cp -R "build_vst3_clap/Villain_artefacts/Release/CLAP/Villain.clap" dmg_contents/CLAP/
          else
            rmdir dmg_contents/CLAP
          fi

          cat > dmg_contents/README.txt << 'README'
          Villain - Fanan Team
          ====================

          Drag each plugin to its install location:

          VST3  →  /Library/Audio/Plug-Ins/VST3/
          AU    →  /Library/Audio/Plug-Ins/Components/
          CLAP  →  /Library/Audio/Plug-Ins/CLAP/

          Then restart your DAW.
          README

          hdiutil create \
            -volname "Villain v${PLUGIN_VERSION}" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            "Villain_Mac_v${PLUGIN_VERSION}.dmg"

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Villain-Mac-v${{ env.PLUGIN_VERSION }}
          path: Villain_Mac_v*.dmg
          if-no-files-found: error